from back.test.unit.src.utils import (
    get_module_at_test,
)
from dataloaders import (
    get_new_context,
)
import pytest
from vulnerability_files.download import (
    get_vulnerabilities_by_type,
    get_vulnerabilities_file,
)

MODULE_AT_TEST = get_module_at_test(file_path=__file__)

pytestmark = [
    pytest.mark.asyncio,
]


async def test_get_vulnerabilities_by_type() -> None:
    context = get_new_context()
    finding_id = "422286126"
    test_data = await get_vulnerabilities_by_type(context, finding_id)
    expected_output = {
        "ports": [],
        "lines": [
            {
                "path": "test/data/lib_path/f060/csharp.cs",
                "line": "12",
                "state": "open",
                "source": "analyst",
                "tool": {"name": "tool-2", "impact": "indirect"},
                "commit_hash": "ea871eee64cfd5ce293411efaf4d3b446d04eb4a",
                "cvss_v3": (
                    "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N/E:P/"
                    "RL:O/RC:C"
                ),
                "cwe_ids": ["CWE-1035", "CWE-770", "CWE-937"],
            },
            {
                "path": "universe/path/to/file3.ext",
                "line": "347",
                "state": "rejected",
                "source": "analyst",
                "tool": {"name": "tool-1", "impact": "direct"},
                "commit_hash": "e17059d1e17059d1e17059d1e17059d1e17059d1",
                "repo_nickname": "universe",
            },
            {
                "path": "universe/path/to/file3.ext",
                "line": "345",
                "state": "submitted",
                "source": "analyst",
                "tool": {"name": "tool-1", "impact": "direct"},
                "commit_hash": "e17059d1e17059d1e17059d1e17059d1e17059d1",
                "repo_nickname": "universe",
            },
        ],
        "inputs": [],
    }
    assert test_data == expected_output


async def test_get_vulnerabilities_file() -> None:
    context = get_new_context()
    finding_id = "988493279"
    group_name = "unittesting"
    assert (
        f"reports/{group_name}-{finding_id}"
        in await get_vulnerabilities_file(context, finding_id, group_name)
    )
